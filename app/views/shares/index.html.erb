<script src="http://www.webglearth.com/v2/api.js"></script>
<script>
  $(function initialize() {
      $.get( "http://geoip.nekudo.com/api/", function( data ) {
          var shares = gon.shares;
          var defaultCenter = ([shares[shares.length-1].lat, shares[shares.length-1].lon]);
          var options = {
          center: defaultCenter,
          sky: false,
          atmosphere: false,
          zoom: 2,
          tilting: true,
          dragging: true,
        };

        earth = new WE.map('earth_div', options);
        var natural = WE.tileLayer('http://data.webglearth.com/natural-earth-color/{z}/{x}/{y}.jpg', {
          tileSize: 256,
          tms: true
        });
        natural.addTo(earth);

        var toner = WE.tileLayer('http://tile.stamen.com/toner/{z}/{x}/{y}.png', {
          attribution: 'Map tiles by Stamen Design, under CC BY 3.0. Data by OpenStreetMap, under CC BY SA.',
          opacity: 0.6
        });
        toner.addTo(earth);

        

        for (var i=0; i<shares.length; ++i) {
          var share = shares[i];
            var title = share.title;
            var body = share.body;
            var trimmedBody = body.substring(0, 25);
            var trimmedBody2 = body.substring(25, 100);
            var lat = share.lat;
            var lon = share.lon;
            var latLon = [lat, lon];
            var marker = WE.marker(latLon).addTo(earth)
            marker.bindPopup("<b>" + title + "</b><br>" + trimmedBody + "<br /><span style='font-size:10px;color:#999'>" + trimmedBody2 + "...</span>");
          }
      });
  })
</script>

<div class="row">
  <div id="earth_div" class="col-xs-10 col-xs-offset-1 col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3"></div> 
</div>

<div class="row">
  <div class="col-xs-12">
    <h1>Shares</h1>
    <br />
  </div>
</div>

<div class="row">
  <div class="col-xs-10 col-xs-offset-1 col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
    <% @shares.each do |share| %>
      <div class="booyah-box post">
        <div class="handle">
          <h4><%= link_to share.title, share_path(share) %></h4>
          <p>
          <%= linkify_hashtags(truncate_html(markdown(share.body), length: 100)) %>
          </p>
          <small><%= share.user.name  %></small>
          <p><%= pluralize(share.votes.count, "votes") %></p>
        </div>

        <br />
        <br />
      
        <% share.comments.first(3).each do |comment| %>
          <blockquote>
            <%= comment.body %><br />
            <small><%= comment.user.email %></small>
          </blockquote>
        <% end %>

        <br />
  
        <% if share_owner?(share) %>
        <div>
          <div class="btn btn-danger">
            <%= link_to 'Delete', share_path(share), method: :delete, data: {confirm: 'Are you sure?'} %>
          </div>
          <div class="btn btn-warning">
            <%= link_to 'Edit', edit_share_path(share) %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>